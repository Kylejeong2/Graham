generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum DocumentStatus {
  PROCESSING
  COMPLETED
  FAILED
}

model Agent {
  id                          String                      @id @default(uuid())
  name                        String
  createdAt                   DateTime                    @default(now())
  userId                      String
  phoneNumber                 String?
  lastModificationTimestamp   String?
  areaCode                    String?
  minutesUsed                 Int                         @default(0)
  // Deployment info 
  deployed                    Boolean                     @default(false)
  roomName                    String?
  roomSid                     String?
  lastDeployedAt              DateTime?
  containerId                 String?
  sipTrunkId                  String?
  // Agent Customization
  voiceId                     String?
  voiceName                   String?
  systemPrompt                String?
  initialMessage              String?
  customResponses             Json                        @default("{}")
  initiateConversation        Boolean                     @default(false)
  ragDocumentId               String? // id of document used for phone rag
  // Relations
  user                        User                        @relation(fields: [userId], references: [id])
  usageRecords                UsageRecord[]
  googleCalendarIntegrations  GoogleCalendarIntegration[]
  callLogs                    CallLog[]
}

model BusinessDocument {
  id            String         @id @default(cuid())
  agentId       String
  userId        String         // Added userId to connect documents with users
  user          User           @relation(fields: [userId], references: [id]) // Relation to User
  fileName      String
  fileType      String
  fileSize      Int
  uploadedAt    DateTime       @default(now())
  status        DocumentStatus  @default(PROCESSING)
  indexPath     String          // Path to LlamaIndex storage
  metadata      Json?           // Store any additional metadata

  @@index([agentId])
}

model UsageRecord {
  id          String    @id @default(uuid())
  userId      String
  agentId     String
  minutesUsed Decimal
  secondsUsed Decimal
  voiceType   String
  timestamp   DateTime  @default(now())
  agent       Agent     @relation(fields: [agentId], references: [id])
  user        User      @relation(fields: [userId], references: [id])
}

model CallLog {
  id            String    @id @default(uuid())
  userId        String
  agentId       String
  timestamp     String
  duration      Int
  summary       String?
  outcome       String?
  transcription String?
  callerNumber  String
  secondsUsed   Int
  minutesUsed   Int
  callData      Json
  agent         Agent     @relation(fields: [agentId], references: [id])
  user          User      @relation(fields: [userId], references: [id])
}

model Subscription { // If the user setup payment intent then they have a subscription
  id                          String                      @id @default(cuid())
  userId                      String                      @unique
  status                      String
  updatedAt                   DateTime                    @updatedAt
  stripeCustomerId            String?                     @unique
  stripePlanId                String?
  stripePriceId               String?
  subscriptionName            String?
  subscriptionStatus          String?
  stripeSubscriptionId        String?
  subscriptionCancelAt        DateTime?
  stripeCurrentPeriodEnd      DateTime?
  phoneNumberSubscriptionData Json                        @default("{}")
  user                        User                        @relation(fields: [userId], references: [id])
}

model User {
  id                          String                      @id
  email                       String                      @unique
  createdAt                   DateTime                    @default(now())
  updatedAt                   DateTime                    @default(now())
  emailVerified               DateTime?
  image                       String?
  phoneNumbers                Json                        @default("[]") // Array of phone numbers "+15103401579"
  businessName                String?
  businessAddress             BusinessAddress?
  fullName                    String?
  user_phoneNumber            String?
  hasPaymentSetup             Boolean                     @default(false)
  agents                      Agent[]
  usageRecords                UsageRecord[]
  userSettings                UserSettings?
  googleCalendarIntegrations  GoogleCalendarIntegration[]
  organization                Organization?                @relation(fields: [organizationId], references: [id])
  organizationId              String?
  subscriptions               Subscription[]
  businessDocuments           BusinessDocument[]          // Added relation to BusinessDocument
  callLogs                    CallLog[]
}

model Waitlist {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())
}

model Lead {
  id          String   @id @default(uuid())
  name        String
  email       String   @unique
  phoneNumber String
  createdAt   DateTime @default(now())
}

model UserSettings {
  userId         String   @id @map("user_id")
  stopLossAmount Decimal? @map("stop_loss_amount")
  user           User     @relation(fields: [userId], references: [id])
}

model EnterpriseContact {
  id          String   @id @default(uuid())
  name        String
  email       String
  phoneNumber String?
  createdAt   DateTime @default(now())
  message     String
  company     String
  inquiryType String
}

model BlogPost {
  id         String   @id @default(uuid())
  title      String
  content    String
  slug       String   @unique
  published  Boolean  @default(false)
  coverImage String?  // url to be the cover image of the blog post
  createdAt  DateTime @default(now())
}

model GoogleCalendarIntegration {
  id           String   @id @default(cuid())
  userId       String
  agentId      String
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
  agent        Agent    @relation(fields: [agentId], references: [id])

  @@unique([userId, agentId])
}

model Organization {
  id                                String   @id @default(uuid())
  name                              String
  stripeCustomerId                  String?  @unique
  stripeSubscriptionId              String?
  stripeSubscriptionPriceId         String?
  stripeSubscriptionStatus          String?
  stripeSubscriptionCurrentPeriodEnd BigInt?
  createdAt                         DateTime @default(now())
  updatedAt                         DateTime @default(now())
  users                             User[]
}

model BusinessAddress {
  id          String   @id @default(cuid())
  userId      String   @unique
  street      String
  city        String
  state       String
  postalCode  String
  country     String   @default("US")
  verified    Boolean  @default(false)
  user        User     @relation(fields: [userId], references: [id])
}
